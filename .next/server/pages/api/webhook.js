"use strict";(()=>{var e={};e.id=538,e.ids=[538],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},4217:e=>{e.exports=require("micro")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},4275:e=>{e.exports=require("resend")},6090:e=>{e.exports=import("stripe")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,o){return o in r?r[o]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,o)):"function"==typeof r&&"default"===o?r:void 0}}})},525:(e,r,o)=>{o.a(e,async(e,t)=>{try{o.r(r),o.d(r,{config:()=>u,default:()=>c,routeModule:()=>p});var n=o(1802),s=o(7153),i=o(6249),a=o(3071),l=e([a]);a=(l.then?(await l)():l)[0];let c=(0,i.l)(a,"default"),u=(0,i.l)(a,"config"),p=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/webhook",pathname:"/api/webhook",bundlePath:"",filename:""},userland:a});t()}catch(e){t(e)}})},9115:(e,r,o)=>{o.a(e,async(e,t)=>{try{o.d(r,{GG:()=>a,S5:()=>i});var n=o(6090),s=e([n]);n=(s.then?(await s)():s)[0];let i=(process.env.STRIPE_SECRET_KEY||"").startsWith("sk_test_"),a=new n.default(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"});t()}catch(e){t(e)}})},3071:(e,r,o)=>{o.a(e,async(e,t)=>{try{o.r(r),o.d(r,{config:()=>E,default:()=>m});var n=o(4217),s=o(9115),i=o(4275),a=o(2885),l=e([s]);s=(l.then?(await l)():l)[0];let E={api:{bodyParser:!1}},g=new i.Resend(process.env.RESEND_API_KEY),_=(0,a.createClient)(process.env.SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{persistSession:!1}}),T=process.env.SUPABASE_STORAGE_BUCKET||"toolkit",S=(()=>{let e=(process.env.SUPABASE_TOOLKIT_PREFIX||"").trim();return e?e.endsWith("/")?e:e+"/":""})(),P=parseInt(process.env.LINK_TTL_HOURS||"24",10),k=(process.env.SUPABASE_TOOLKIT_ZIP||"").trim(),v={toolkit:"ThreadLock Toolkit",founders:"Founders Access","support-nyop":"Support (one-time)","support-monthly":"Support ($2/mo)","common-mistakes":"Avoiding Common Mistakes in Court","basic-motion":"Basic Motion Template","case-timeline":"Case Event Timeline Worksheet","common-response":"Common Legal Response Timelines","cross-exam":"Direct & Cross-Examination Planning","evidence-log":"Evidence Tracking Log","find-rules":"Finding the Right Court Rules","pre-hearing":"Pre-Hearing Preparation Checklist","proof-of-service":"Proof of Service Tracker","trial-quick-ref":"Trial & Hearing Quick Reference"},w={"common-mistakes":["avoiding common mistakes in court.pdf"],"basic-motion":["basic motion template.pdf"],"case-timeline":["case event timeline worksheet.pdf"],"common-response":["common legal response timelines.pdf"],"cross-exam":["direct & cross-examination planning.pdf"],"evidence-log":["evidence tracking log.pdf"],"find-rules":["finding the right court rules.pdf"],"pre-hearing":["pre-hearing preparation checklist.pdf"],"proof-of-service":["proof of service tracker.pdf"],"trial-quick-ref":["trial & hearing quick reference.pdf"]};async function c(e){let r;let o=e.headers["stripe-signature"],t=await (0,n.buffer)(e),i=[["STRIPE_WEBHOOK_SECRET_TEST",process.env.STRIPE_WEBHOOK_SECRET_TEST],["STRIPE_WEBHOOK_SECRET_LIVE",process.env.STRIPE_WEBHOOK_SECRET_LIVE||process.env.STRIPE_WEBHOOK_SECRET]].filter(([,e])=>!!e);if(!i.length)throw Error("Missing STRIPE_WEBHOOK_SECRET_TEST and STRIPE_WEBHOOK_SECRET_LIVE envs");for(let[e,n]of i)try{let r=s.GG.webhooks.constructEvent(t,o,n);return r._verified_with=e,r}catch(e){r=e}throw Error(`Webhook signature failed for all secrets: ${r?.message||"unknown error"}`)}async function u(){let{data:e,error:r}=await _.storage.from(T).list(S||void 0,{limit:200,offset:0});if(r)throw Error(`Supabase list error: ${r.message}`);return(e||[]).filter(e=>!!e?.name&&e.name.includes("."))}async function p(e){let r=3600*P,o=[];for(let t of e){let e=S?`${S}${t}`:t,{data:n,error:s}=await _.storage.from(T).createSignedUrl(e,r);if(s)throw Error(`Signed URL error for ${t}: ${s.message}`);o.push({name:t,url:n.signedUrl})}return o}async function d(){let e=(await u()).map(e=>e.name);if(k){if(e.includes(k))return console.log("Using configured toolkit ZIP:",k),p([k]);console.warn(`Configured SUPABASE_TOOLKIT_ZIP not found in bucket: ${k}`)}let r=e.filter(e=>/\.zip$/i.test(e)),o=r.find(e=>/(toolkit|full|bundle|complete|all)/i.test(e))||r[0];return o?(console.log("Auto-selected toolkit ZIP:",o),p([o])):(console.warn("No ZIP found for toolkit; falling back to ALL files (legacy behavior)."),p(e))}async function f(e){if(!e)return[];if("toolkit"===e)return d();let r=(await u()).map(e=>e.name),o=(w[e]||[]).map(e=>e.toLowerCase());if(!o.length)return[];let t=r.filter(e=>{let r=e.toLowerCase();return o.some(e=>r.includes(e))});return p(t)}function h(e){switch(e){case"founders":return"There are no downloads with this purchase. Your Founders perks will be applied at launch. We will keep you updated on our progress by email.";case"support-monthly":return"There are no downloads with this purchase. Your monthly support is now active. Thank you for backing the build!";case"support-nyop":return"There are no downloads with this purchase. Thank you for supporting the build!";default:return"There are no downloads for this purchase. If this seems wrong, reply to this email."}}async function m(e,r){let o;if("POST"!==e.method)return r.setHeader("Allow","POST"),r.status(405).send("Method Not Allowed");try{o=await c(e)}catch(e){return console.error("❌ Signature error:",e.message),r.status(400).send("Invalid signature")}try{if("checkout.session.completed"===o.type){let e=o.data.object,r=e.customer_details?.email||e.customer_email||null,t=e.metadata?.slug||null;console.log("✅ checkout.session.completed",{id:e.id,email:r,slug:t,verifiedWith:o._verified_with});let n=[];try{n=await f(t)}catch(e){throw console.error("Supabase error:",e.message),e}try{let{subject:o,html:s,text:i}=function({email:e,links:r,session:o,slug:t}){let n=v[t]||"Your Order",s=r.length>0,i=o.id,a=s?`Your ${n} is ready`:`Thanks for your purchase of ${n}`,l=s?`
        <p>Thanks for your purchase${e?`, ${e}`:""}. Download link${r.length>1?"s are":" is"} below (valid for ${P} hours):</p>
        <ul>
          ${r.map(({name:e,url:r})=>`<li style="margin:6px 0"><a href="${r}" target="_blank" rel="noopener">${e}</a></li>`).join("")}
        </ul>`:`
        <p>Thanks for your purchase${e?`, ${e}`:""}.</p>
        <p>${h(t)}</p>
      `,c=`
      <div style="font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.45">
        <h2>${a}</h2>
        ${l}
        <p style="color:#64748b;font-size:13px;margin-top:18px">
          Order Reference: ${i}<br/>
          Need help? Reply to this email.
        </p>
      </div>`,u=s?`${a}

${r.map(e=>`• ${e.name}: ${e.url}`).join("\n")}

Links valid for ${P} hours.
Order Reference: ${i}`:`${a}

${h(t)}
Order Reference: ${i}`;return{subject:a,html:c,text:u}}({email:r,links:n,session:e,slug:t});r?await g.emails.send({from:process.env.EMAIL_FROM||"ThreadLock <info@threadlock.ai>",to:r,reply_to:process.env.EMAIL_REPLY_TO||void 0,subject:o,html:s,text:i}):console.warn("⚠️ No customer email on session",e.id)}catch(e){throw console.error("Resend error:",e.message),e}}else console.log("ℹ️ Unhandled event:",o.type)}catch(e){return console.error("⚠️ Webhook handler error:",e),r.status(500).send("Webhook handler error")}return r.json({received:!0})}t()}catch(e){t(e)}})},7153:(e,r)=>{var o;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return o}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(o||(o={}))},1802:(e,r,o)=>{e.exports=o(145)}};var r=require("../../webpack-api-runtime.js");r.C(e);var o=r(r.s=525);module.exports=o})();